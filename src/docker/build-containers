#!/usr/bin/env bash
#
# Unified Build Tool
# Copyright (C) 2021-2024 by Thomas Dreibholz
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Contact: thomas.dreibholz@gmail.com

set -eu


cp ../pbuilderrc .

export BUILDKIT_COLORS="run=123,20,245:error=yellow:cancel=blue:warning=white"


# ====== Prepare insecure builder ===========================================
docker buildx create --name insecure-builder --buildkitd-flags '--allow-insecure-entitlement security.insecure' || true

# ====== Base image with PBuilder and QEMU ==================================
docker buildx build --push --builder insecure-builder --progress=plain \
   --file=Dockerfile.td-build-tools-pbuilder \
   --tag dreibh/td-build-tools-pbuilder:latest \
   .

# ====== Initialised PBuilder with certain Distribution/Architecture ========
os=ubuntu
for distribution in noble ; do
   for architecture in amd64 arm64 ; do
      docker buildx build --load --builder insecure-builder --progress=plain \
         --allow security.insecure \
         --file=Dockerfile.ubuntu-pbuilder \
         --tag "dreibh/td-build-tools-pbuilder-${os}-${distribution}-${architecture}:latest" \
         --build-arg OS="${os}" \
         --build-arg DIST="${distribution}" \
         --build-arg ARCH="${architecture}" \
         .
   done
done
